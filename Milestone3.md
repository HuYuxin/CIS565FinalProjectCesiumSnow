# Cesium Snow Rendering Milestone3

## Prepared by Anton Khabbaz, Yaoyi Bai, Yuxin Hu

### Overview

In this milestone we added normal map to snow material to add some bumpness over the snow surface. We added perlin noise to slope of snow material to add randomness to snow coverage. We also added screen space snow falling using post processing.

Normal Map + PerlinNoise on Slope      |  Normal Map + PerlinNoise on Slop with Threshold
:-------------------------------------:|:---------------------------------------------------:
![](/image/NormalWithPerlinNoise.PNG)  |  ![](/image/Canyon2DPerlinNoiseNormalMapWithThreshold.PNG)


### Features Implemented
**Perlin Noise On Snow Slope**

* The snow slope is used to blend a white color with the texture of the terrain. Now that slope amplitude is modulated by perlin noise.
There is a 2D texture of random noise used which is used for generating random values. A random float is generated by interpolating a 2D texture

![](/image/RandomColor.png)

with a 3D coordinate. In the current implementation the 3D coordinate is the model space position. This has the nice property that as you pan around, the snow drifts are fixed with the terrain, not the camera.  

The 3D noise function was writted by Stefan Gustafson from 2004.

In snow materials one can change the repetition scale

SCALE = 100000;

Change the persistance 

persistance = 0.5

Change how much noise is added to the slope

NoiseFraction = 0.4 (according to Snow paper)

Change the number of octaves to add in

orders = 5 

![](/image/Canyon3DPerlin_O5_P0r5_S100000.PNG)


**Adding Normal Map to Snow Material**

* To make snow looks bumpy and realistic, we added normal map to the snow material. Inside snow material shader, we read a value from the normal map using the uv coordinates of the fragment, as the normal in model space. Then we transform the normal in model space to eye space. Inside GlobeFS shader, I use the normal read from the material for shading. I added specular term in shading to show the glittering effect of snow. The final formula I used for snow shading is:

**color.rgb * diffuseIntensity * 0.8  + specular * specularIntensity * 0.2**

Here are some results of applying normal maps to snow material.

![](/image/snowNormalMap.jpg)

![](/image/snowRenderNormalMap.PNG)
<p>Snow material with normal map 1</p>

![](/image/snowNormalMap2.jpg)

![](/image/snowRenderNormalMap2.PNG)
<p>Snow material with normal map 2</p>

![](/image/snowNormalMap3.jpg)

![](/image/snowRenderNormalMap3.PNG)
<p>Snow material with normal map 3</p>

Among the three results, we think the second normal map works the best. Therefore we will use the snowNormalMap2 for our snow material.

**Screenspace Snow Falling As Post Processing**

* We added a post processing layer to add snow falling particles. For each fragment we will calculate its' alpha value to indicate the probability of snow by reading values from a gray noise texture. We pass a time uniform variable into the shader to make the snow particle moving.

![](/image/SnowFallingParticles.gif)

We also added tunable parameters to change how fast and how heavy the snow is.

![](/image/SnowChangeSpeed.gif)

![](/image/SnowChangeThickness.gif)


### Plans for final milestone

* Milestone 4: Fix the square shape snow particles. Add the option to toggle noise in normal and slope to show the difference. Add wind forces to snow. Change the skybox color to darker when it is snow. Stretch goal: identify the ocean area and do not apply snow material over ocean.

### References

[glsl Noise Algorithms](https://gist.github.com/patriciogonzalezvivo/670c22f3966e662d2f83)